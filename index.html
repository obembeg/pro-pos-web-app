<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Pro POS â€“ Smart Business Manager</title>

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4f46e5" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" href="icon.png" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-main: #f8fafc;
            --bg-panel: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --receipt-width: 80mm;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Inter", sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout Structure */
        .sidebar {
            flex: 1;
            max-width: 500px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                overflow: auto;
                height: auto;
            }

            .sidebar {
                max-width: 100%;
                border-right: none;
                height: auto;
            }

            .main-view {
                padding-bottom: 100px;
                height: auto;
            }
        }

        .main-view {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            background: radial-gradient(circle at top right, #eef2ff, transparent);
        }

        /* Sidebar Content */
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(to bottom right, #4f46e5, #6366f1);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 16px;
            margin: 0;
            font-weight: 800;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-chip {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-chip:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            box-shadow: 0 0 8px #10b981;
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Styles */
        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-main);
        }

        input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Item Table in Sidebar */
        .items-list {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .item-row {
            display: grid;
            grid-template-columns: 1fr 50px 70px 30px;
            gap: 6px;
            padding: 8px;
            background: white;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .item-row input {
            padding: 6px 8px;
            font-size: 12px;
        }

        .btn-icon {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            color: #ef4444;
            background: #fee2e2;
        }

        /* Receipt Preview Card */
        .receipt-container {
            position: relative;
            filter: drop-shadow(0 20px 25px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .receipt-container:hover {
            transform: translateY(-5px);
        }

        .receipt {
            width: var(--receipt-width);
            background: #fff;
            padding: 20px;
            font-family: "JetBrains Mono", monospace;
            font-size: 11px;
            color: #000;
            min-height: 400px;
            position: relative;
        }

        /* Paper texture effect */
        .receipt::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    rgba(0, 0, 0, 0.02) 0%,
                    transparent 5%,
                    transparent 95%,
                    rgba(0, 0, 0, 0.02) 100%);
            pointer-events: none;
        }

        .receipt h2 {
            font-size: 16px;
            text-align: center;
            margin: 10px 0 5px;
            text-transform: uppercase;
        }

        .receipt .center {
            text-align: center;
            margin-bottom: 2px;
            font-size: 10px;
        }

        .receipt .divider {
            border-top: 1px dashed #ccc;
            margin: 10px 0;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10px;
        }

        .receipt-table th {
            text-align: left;
            border-bottom: 1px solid #000;
            padding: 6px 4px;
        }

        .receipt-table td {
            padding: 6px 4px;
            vertical-align: top;
        }

        .text-right {
            text-align: right !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-left {
            text-align: left !important;
        }

        .receipt-totals {
            margin-top: 10px;
        }

        .receipt-totals div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        /* Dashboard Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        button.primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        button.primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        button.secondary {
            background: white;
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        button.secondary:hover {
            background: var(--bg-main);
            border-color: var(--text-muted);
        }

        /* Dashboard UI */
        .summary-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-card .label {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 700;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        .summary-card .value {
            font-size: 16px;
            font-weight: 700;
        }

        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .tag-btn {
            background: white;
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tag-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #f5f3ff;
            transform: translateY(-1px);
        }

        /* History Cards */
        .history-section {
            padding: 12px 16px;
            background: #f1f5f9;
            border-top: 1px solid var(--border);
            max-height: 350px;
            display: flex;
            flex-direction: column;
        }

        #historyList {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
            overflow-y: auto;
        }

        .history-card {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-card:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .history-card .meta {
            color: var(--text-muted);
            margin-right: 10px;
            line-height: 1.4;
        }

        .history-card .meta strong {
            display: block;
            color: var(--text-main);
            font-size: 13px;
        }

        .history-card .total {
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
        }

        .badge {
            background: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge.status-received {
            background: #e0e7ff;
            color: #4338ca;
        }

        .badge.status-processing {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.status-ready {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.status-collected {
            background: #f3f4f6;
            color: #374151;
        }

        /* Payment Badges */
        .badge.pay-paid {
            background: #dcfce7;
            color: #166534;
        }

        .badge.pay-unpaid {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge.pay-partial {
            background: #ffedd5;
            color: #9a3412;
        }

        select.badge {
            border: 1px solid transparent;
            cursor: pointer;
            outline: none;
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            padding-right: 18px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
        }

        select.badge:hover {
            opacity: 0.9;
            transform: scale(1.02);
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* Floating Analytics Box */
        .analytics-box {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            border-radius: 16px;
            color: white;
            display: flex;
            gap: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 700;
            color: #94a3b8;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }

        .stat-trend {
            font-size: 10px;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* Setup Overlay */
        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            z-index: 2000;
            display: none;
            /* Controlled by JS */
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .setup-card {
            background: white;
            padding: 32px;
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .setup-card h2 {
            margin-top: 0;
            font-size: 22px;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .setup-card p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .setup-card .input-group label {
            font-weight: 600;
            color: var(--text-main);
        }

        .setup-card input,
        .setup-card textarea {
            background: #f8fafc;
            border: 1px solid var(--border);
        }

        .setup-card textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            min-height: 60px;
            resize: none;
            margin-bottom: 12px;
        }

        .settings-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: #f1f5f9;
            color: var(--primary);
            transform: rotate(45deg);
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .login-card {
            text-align: center;
            max-width: 300px;
            width: 100%;
        }

        .pin-display {
            font-size: 32px;
            letter-spacing: 12px;
            margin-bottom: 24px;
            font-weight: 700;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .pin-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            height: 60px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pin-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .pin-btn.delete {
            color: #ef4444;
        }

        /* Staff Switcher Style */
        .staff-bar {
            padding: 12px 16px;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .staff-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
            font-weight: 600;
        }

        .staff-badge {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
        }

        .staff-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .staff-list-item span {
            font-size: 13px;
            font-weight: 500;
        }

        .staff-select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 11px;
            background: white;
            cursor: pointer;
        }

        /* Chart Section */
        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-top: 24px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .analytics-grid-card {
            background: #f8fafc;
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .analytics-grid-card .val {
            font-size: 20px;
            font-weight: 800;
            color: var(--primary);
        }

        .analytics-grid-card .lbl {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .analytics-list-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .analytics-list-item:last-child {
            border-bottom: none;
        }

        .analytics-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #receipt,
            #receipt * {
                visibility: visible;
            }

            #receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                box-shadow: none;
                filter: none;
            }

            .sidebar,
            .main-view,
            .controls,
            button {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
                <h1 id="sidebar-biz-name"><i data-lucide="sparkles"></i> Smart Business by OG</h1>
                <div style="display: flex; gap: 8px">
                    <button class="settings-btn" onclick="openAnalytics()" title="Business Insights"
                        style="color: white; opacity: 0.8">
                        <i data-lucide="bar-chart-3" style="width: 18px"></i>
                    </button>
                    <button class="settings-btn" onclick="openCustomerDirectory()" title="Customer Directory"
                        style="color: white; opacity: 0.8">
                        <i data-lucide="users" style="width: 18px"></i>
                    </button>
                    <button class="settings-btn" onclick="showSetup()" title="Settings"
                        style="color: white; opacity: 0.8">
                        <i data-lucide="settings" style="width: 18px"></i>
                    </button>
                </div>
            </div>

            <div class="user-chip" onclick="triggerSwitch()" title="Lock / Switch Account">
                <div class="status-dot"></div>
                <span id="currentStaffName">Admin</span>
                <i data-lucide="lock" style="width: 12px; margin-left: auto; opacity: 0.6"></i>
            </div>
        </div>

        <div class="sidebar-scroll">
            <div class="summary-card">
                <div class="label">Today's Total Revenue</div>
                <div class="value" id="dailyTotal">â‚¦0.00</div>
            </div>

            <div class="section-title">
                <i data-lucide="user"></i> Customer Info
            </div>

            <div class="input-group">
                <label>Customer Name</label>
                <div style="display: flex; gap: 8px; align-items: center">
                    <input id="customer" placeholder="John Doe" list="customers" oninput="updateLoyalty()" />
                    <span id="loyalty-badge" class="badge" style="display: none">0 visits</span>
                </div>
                <datalist id="customers"></datalist>
            </div>

            <div class="input-group">
                <label>Phone Number</label>
                <input id="phone" placeholder="080..." />
            </div>

            <div class="input-group">
                <label>Date & Time</label>
                <input id="date" type="text" readonly />
            </div>

            <div class="input-group">
                <label>Order Status</label>
                <select id="orderStatus" class="staff-select" style="
              width: 100%;
              border: 1px solid var(--border);
              padding: 8px;
              border-radius: 6px;
              font-weight: 600;
            ">
                    <option value="Ready">ðŸŸ¢ Ready for Pickup</option>
                    <option value="Collected">ðŸŸ£ Collected</option>
                </select>
            </div>

            <div class="input-group">
                <label>Payment Status</label>
                <select id="paymentStatus" class="staff-select" onchange="togglePaidInput();calculate();" style="
              width: 100%;
              border: 1px solid var(--border);
              padding: 8px;
              border-radius: 6px;
              font-weight: 600;
              background: white;
            ">
                    <option value="Not Paid">ðŸ”´ Not Paid</option>
                    <option value="Partly Paid">ðŸŸ  Partly Paid</option>
                    <option value="Paid">ðŸŸ¢ Fully Paid</option>
                </select>
            </div>

            <div class="input-group" id="paidInputGroup" style="display: none">
                <label>Amount Paid (â‚¦)</label>
                <input id="amountPaid" type="number" placeholder="0.00" oninput="calculate()" />
            </div>

            <div class="section-title">
                <i data-lucide="package"></i> Order Items
                <button onclick="addItem()" class="btn-icon" style="
              margin-left: auto;
              color: var(--primary);
              background: #eef2ff;
            ">
                    <i data-lucide="plus-circle" style="width: 18px"></i>
                </button>
            </div>

            <div class="quick-tags" id="quickTags">
                <!-- JS will populate tags -->
            </div>

            <div id="sidebarItems" class="items-list">
                <!-- JS will populate rows here -->
            </div>

            <div class="controls">
                <button class="primary" onclick="saveReceipt(event)" title="Save to History">
                    <i data-lucide="save"></i> Save
                </button>
                <button class="primary" style="background: #25d366" onclick="shareWhatsApp()" title="Send to WhatsApp">
                    <i data-lucide="message-circle"></i> WhatsApp
                </button>
                <button class="secondary" onclick="window.print()" title="Print Receipt">
                    <i data-lucide="printer"></i> Print
                </button>
                <button class="secondary" onclick="resetForm()" title="New Receipt">
                    <i data-lucide="rotate-ccw"></i> New
                </button>
            </div>

            <div class="history-section">
                <div class="section-title" style="
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
                    <span><i data-lucide="history"></i> Recent Sales</span>
                    <div style="display: flex; gap: 8px">
                        <button onclick="exportHistory()" style="
                background: none;
                border: none;
                color: var(--text-muted);
                font-size: 10px;
                cursor: pointer;
              " title="Export to CSV">
                            <i data-lucide="download" style="width: 12px"></i> CSV
                        </button>
                        <button onclick="toggleAllHistory()" id="historyToggleBtn" style="
                background: none;
                border: none;
                color: var(--primary);
                font-size: 10px;
                cursor: pointer;
                font-weight: 700;
              ">
                            SHOW ALL
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 4px; margin-bottom: 8px">
                    <input id="historySearch" placeholder="Filter by name..." oninput="renderHistory()" style="
              flex: 1;
              background: white;
              font-size: 12px;
              padding: 6px 10px;
              border: 1px solid var(--border);
              border-radius: 4px;
            " />
                    <select id="historyStatusFilter" onchange="renderHistory()" style="
              font-size: 11px;
              border: 1px solid var(--border);
              border-radius: 4px;
              padding: 0 4px;
              background: white;
              font-weight: 600;
              cursor: pointer;
            ">
                        <option value="All">All Status</option>
                        <option value="Received">ðŸ”µ Received</option>
                        <option value="Processing">ðŸŸ¡ Processing</option>
                        <option value="Ready">ðŸŸ¢ Ready</option>
                        <option value="Collected">ðŸŸ£ Collected</option>
                    </select>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </aside>

    <main class="main-view">
        <div class="receipt-container">
            <div class="receipt" id="receipt">
                <div class="center" id="p-biz-name" style="font-weight: 700; font-size: 13px">
                    BUSINESS NAME
                </div>
                <div class="center" id="p-biz-address">Business Address Line</div>
                <div class="center" id="p-biz-phone">Phone Numbers</div>
                <div class="divider"></div>
                <h2>INVOICE</h2>
                <div class="divider"></div>

                <div style="margin-bottom: 5px">
                    <strong>Customer:</strong> <span id="p-customer">---</span>
                </div>
                <div style="margin-bottom: 5px">
                    <strong>Phone:</strong> <span id="p-phone">---</span>
                </div>
                <div style="margin-bottom: 5px">
                    <strong>Date:</strong> <span id="p-date">---</span>
                </div>

                <div class="divider"></div>

                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th width="35%">Item</th>
                            <th width="15%" class="text-center">Qty</th>
                            <th width="20%" class="text-right">Price</th>
                            <th width="25%" class="text-right">Sum â‚¦</th>
                        </tr>
                    </thead>
                    <tbody id="p-itemsBody"></tbody>
                </table>

                <div class="divider"></div>

                <div class="receipt-totals">
                    <div><span>Subtotal:</span> <span id="p-subtotal">â‚¦0.00</span></div>
                    <div id="p-old-balance-row" style="display: none;"><span>Old Balance:</span> <span
                            id="p-old-balance">â‚¦0.00</span></div>
                    <div style="
                font-weight: 700;
                font-size: 13px;
                border-top: 1px solid #000;
                padding-top: 4px;
                margin-top: 4px;
              ">
                        <span>TOTAL:</span> <span id="p-total">â‚¦0.00</span>
                    </div>
                    <div style="font-size: 10px; margin-top: 4px;">
                        <span>Paid:</span> <span id="p-paid">â‚¦0.00</span>
                    </div>
                    <div style="font-style: italic; font-size: 10px; font-weight: 700;">
                        Balance: <span id="p-due">â‚¦0.00</span>
                    </div>
                    <div style="font-size: 9px; margin-top: 2px; color: #666;">
                        Status: <span id="p-pay-status">Not Paid</span>
                    </div>
                </div>

                <div class="divider"></div>
                <div id="p-bank-details" style="font-size: 10px; margin-top: 5px; display: none;">
                    <strong>PAYMENT DETAILS:</strong><br>
                    <span id="p-bank-name"></span><br>
                    <span id="p-account-number"></span><br>
                    <span id="p-account-name"></span>
                </div>
                <div class="divider"></div>
                <div style="font-size: 10px; margin-top: 4px; color: #555">
                    Operator: <span id="p-staff">Admin</span>
                </div>
                <div class="center" style="font-size: 9px; margin-top: 10px">
                    Thanks for choosing <span id="p-footer-biz">our business</span>!
                </div>
                <div style="text-align: right; font-size: 7px; color: #999; margin-top: 10px;">
                    app developed by OG 08105781658
                </div>
            </div>
        </div>

    </main>

    <!-- Sales Dashboard -->
    <div class="analytics-box" id="analyticsBox" style="gap: 12px; padding: 12px 24px;">
        <div class="stat-item">
            <div class="stat-label">Today's Revenue</div>
            <div class="stat-value" id="statDaily">â‚¦0.00</div>
        </div>
        <div style="width: 1px; background: rgba(255, 255, 255, 0.1)"></div>
        <div class="stat-item">
            <div class="stat-label">Pending Collection</div>
            <div class="stat-value" id="statPendingCount">0</div>
        </div>
        <div style="width: 1px; background: rgba(255, 255, 255, 0.1)"></div>
        <div class="stat-item">
            <div class="stat-label">Unpaid Balance</div>
            <div class="stat-value" id="statUnpaidDebt" style="color: #fda4af;">â‚¦0.00</div>
        </div>
        <button onclick="document.getElementById('analyticsBox').style.display = 'none'" class="btn-icon"
            style="color: #94a3b8; margin-left: 10px">
            <i data-lucide="x-circle" style="width: 16px"></i>
        </button>
    </div>

    <!-- Business Setup Overlay -->
    <div id="setupOverlay" class="setup-overlay">
        <div class="setup-card">
            <div style="
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
          ">
                <div>
                    <h2>
                        <i data-lucide="store" style="color: var(--primary)"></i> Setup &
                        Data
                    </h2>
                    <p>Configure your business and manage your data backups.</p>
                </div>
                <button id="closeSetup" onclick="hideSetup()" class="btn-icon" style="display: none">
                    <i data-lucide="x" style="width: 20px"></i>
                </button>
            </div>

            <div style="max-height: 400px; overflow-y: auto; padding-right: 5px">
                <div class="input-group">
                    <label>Business Name</label>
                    <input id="setup-name" placeholder="E.g. Klassy Klean Garment Care" />
                </div>

                <div class="input-group">
                    <label>Business Address</label>
                    <textarea id="setup-address" placeholder="Full address of your shop..."></textarea>
                </div>

                <div class="input-group">
                    <label>Contact Phone(s)</label>
                    <input id="setup-phone" placeholder="E.g. 08051353581, 08105781658" />
                </div>

                <div class="input-group">
                    <label>Admin Passcode (4-digit)</label>
                    <input id="setup-admin-pin" type="password" maxlength="4" placeholder="Default: 0000" />
                </div>

                <div class="section-title">
                    <i data-lucide="credit-card"></i> Payment Details
                </div>
                <div class="input-group">
                    <label>Bank Name</label>
                    <input id="setup-bank-name" placeholder="e.g. GTBank, Zenith" />
                </div>
                <div class="input-group">
                    <label>Account Number</label>
                    <input id="setup-account-number" placeholder="10-digit account number" maxlength="10" />
                </div>
                <div class="input-group">
                    <label>Account Name</label>
                    <input id="setup-account-name" placeholder="Name on account" />
                </div>

                <div class="section-title">
                    <i data-lucide="users"></i> Staff Management
                </div>
                <div style="margin-bottom: 12px">
                    <div style="
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 10px;
              ">
                        <input id="newStaffName" placeholder="Staff Name" />
                        <div style="display: flex; gap: 8px">
                            <input id="newStaffPin" type="password" maxlength="4" placeholder="4-digit PIN"
                                style="flex: 1" />
                            <button class="primary" onclick="addStaffMember()" style="padding: 0 16px">
                                Add Staff
                            </button>
                        </div>
                    </div>
                    <div id="staffManageList">
                        <!-- Staff list items will appear here -->
                    </div>
                </div>

                <div class="section-title">
                    <i data-lucide="database"></i> Data Management
                </div>
                <div style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 10px;
              margin-top: 10px;
            ">
                    <button class="secondary" onclick="exportHistory()" style="font-size: 11px">
                        <i data-lucide="download" style="width: 14px"></i> Export CSV
                    </button>
                    <button class="secondary" onclick="clearAllData()"
                        style="font-size: 11px; color: #ef4444; border-color: #fee2e2">
                        <i data-lucide="trash-2" style="width: 14px"></i> Clear History
                    </button>
                </div>
            </div>

            <button class="primary" onclick="saveBusinessConfig()" style="width: 100%; margin-top: 24px; height: 44px">
                <i data-lucide="check-circle"></i> Save Profile
            </button>
        </div>
    </div>

    <!-- Customer Directory Overlay -->
    <div id="customerOverlay" class="setup-overlay">
        <div class="setup-card" style="max-width: 600px; width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    <h2><i data-lucide="contact" style="color: var(--primary);"></i> Customer Directory</h2>
                    <p>Manage and track your customer relationships.</p>
                </div>
                <button onclick="closeCustomerDirectory()" class="btn-icon">
                    <i data-lucide="x" style="width: 24px;"></i>
                </button>
            </div>

            <div style="margin-bottom: 16px;">
                <input id="customerSearch" placeholder="Search by name or phone..." oninput="renderCustomerList()"
                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
            </div>

            <div id="customerList"
                style="max-height: 50vh; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
                <!-- JS will inject customers here -->
            </div>

            <div id="customerDetailView"
                style="display: none; border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">
                <button onclick="backToCustomerList()" class="btn-icon"
                    style="margin-bottom: 10px; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                    <i data-lucide="arrow-left" style="width: 14px;"></i> Back to List
                </button>
                <div id="customerDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- Analytics Overlay -->
    <div id="analyticsOverlay" class="setup-overlay">
        <div class="setup-card" style="max-width: 800px; width: 95%;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    <h2><i data-lucide="bar-chart-2" style="color: var(--primary);"></i> Business Analytics</h2>
                    <p>Performance insights and trends for your business.</p>
                </div>
                <button onclick="closeAnalytics()" class="btn-icon">
                    <i data-lucide="x" style="width: 24px;"></i>
                </button>
            </div>

            <div style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 8px;">
                <button id="tab-day" class="tag-btn analytics-tab active"
                    onclick="switchAnalyticsTab('day')">Today</button>
                <button id="tab-week" class="tag-btn analytics-tab" onclick="switchAnalyticsTab('week')">This
                    Week</button>
                <button id="tab-month" class="tag-btn analytics-tab" onclick="switchAnalyticsTab('month')">This
                    Month</button>
                <button id="tab-year" class="tag-btn analytics-tab" onclick="switchAnalyticsTab('year')">This
                    Year</button>
            </div>

            <div id="analyticsContent"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <!-- JS will inject stats here -->
            </div>

            <div style="background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
                <h3
                    style="font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text-main);">
                    <i data-lucide="line-chart" style="width: 16px;"></i> Revenue Trend (Last 7 Days)
                </h3>
                <div style="height: 180px; position: relative;">
                    <canvas id="revenueChartModal"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Overlay (Now moved outside for independent access) -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2 id="loginTitle" style="margin-bottom: 8px">Welcome</h2>
            <p id="loginSubtitle" style="color: #94a3b8; font-size: 14px; margin-bottom: 24px">
                Select account to unlock dashboard
            </p>

            <div id="accountSelector" style="
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 30px;
          ">
                <!-- JS will inject account buttons -->
            </div>

            <div id="pinEntry" style="display: none">
                <button onclick="backToAccounts()" class="btn-icon" style="color: white; margin-bottom: 10px">
                    <i data-lucide="arrow-left" style="width: 16px"></i> Back
                </button>
                <div class="pin-display" id="pinDisplay">****</div>
                <div class="pin-pad">
                    <button class="pin-btn" onclick="pressPin('1')">1</button>
                    <button class="pin-btn" onclick="pressPin('2')">2</button>
                    <button class="pin-btn" onclick="pressPin('3')">3</button>
                    <button class="pin-btn" onclick="pressPin('4')">4</button>
                    <button class="pin-btn" onclick="pressPin('5')">5</button>
                    <button class="pin-btn" onclick="pressPin('6')">6</button>
                    <button class="pin-btn" onclick="pressPin('7')">7</button>
                    <button class="pin-btn" onclick="pressPin('8')">8</button>
                    <button class="pin-btn" onclick="pressPin('9')">9</button>
                    <div></div>
                    <button class="pin-btn" onclick="pressPin('0')">0</button>
                    <button class="pin-btn delete" onclick="clearPin()">
                        <i data-lucide="delete"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Balance Prompt Overlay -->
    <div id="balanceOverlay" class="setup-overlay">
        <div class="setup-card" style="max-width: 350px; text-align: center;">
            <div style="margin-bottom: 20px;">
                <div
                    style="background: #fff1f2; color: #e11d48; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; border: 4px solid #ffe4e6;">
                    <i data-lucide="alert-circle" style="width: 32px; height: 32px;"></i>
                </div>
                <h2 style="justify-content: center; font-size: 20px;">Unpaid Balance!</h2>
                <p id="balancePromptText" style="font-size: 14px; color: var(--text-muted); margin-bottom: 0;">This
                    customer has an outstanding balance of â‚¦0.00.</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="secondary" onclick="resolveBalancePrompt(false)"
                    style="height: 44px; font-weight: 700;">SKIP</button>
                <button class="primary" onclick="resolveBalancePrompt(true)"
                    style="height: 44px; background: #e11d48; font-weight: 700;">ADD IT</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const historyKey = "klassySalesHistory";
        const loyaltyKey = "klassyLoyalty";
        const bizKey = "pos_business_info";
        const staffKey = "pos_staff_list";
        const activeStaffKey = "pos_active_staff";

        let isAuthorizingForSettings = false;
        let targetStaff = "";
        let currentPinDraft = "";
        let revenueChartInstance = null;
        let showAllHistoryItems = false;
        let editingOrderId = null; // Track if we are updating an existing order
        let carriedBalance = 0;
        let currentPromptedCustomer = "";

        const commonServices = [
            { name: "Shirt", price: 700 },
            { name: "Trousers", price: 700 },
            { name: "Suit (3pc)", price: 2500 },
            { name: "Duvet", price: 2500 },
            { name: "Bedspread", price: 1000 },
            { name: "Native", price: 1500 },
            { name: "Top", price: 700 },
            { name: "Singlet", price: 300 },
            { name: "Boxers", price: 300 },
            { name: "Gown", price: 1500 },
        ];

        const $ = (id) => document.getElementById(id);

        function init() {
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("sw.js").then(reg => {
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast("New Update! Reloading...");
                                setTimeout(() => window.location.reload(), 1500);
                            }
                        };
                    };
                }).catch((e) => { });
            }
            const now = new Date();
            if ($("date"))
                $("date").value = now.toLocaleString("en-NG", {
                    dateStyle: "medium",
                    timeStyle: "short",
                });

            loadBusinessConfig();
            if (localStorage.getItem(bizKey)) triggerSwitch();

            renderStaffManagement();
            updateStaffSwitcher();

            const tags = $("quickTags");
            if (tags) {
                tags.innerHTML = commonServices
                    .map(
                        (s) => `
                        <button class="tag-btn" onclick="quickAdd('${s.name}', ${s.price})">
                          <i data-lucide="tag" style="width:12px"></i> ${s.name}
                        </button>
                    `,
                    )
                    .join("");
            }

            resetForm();
            updateCustomerSuggestions();
            renderHistory();
            updateSummary();
            updateChart();
            if (window.lucide) lucide.createIcons();
        }

        function loadBusinessConfig() {
            const config = JSON.parse(localStorage.getItem(bizKey) || "null");
            if (!config) {
                openSetupModal();
                return;
            }
            if ($("sidebar-biz-name"))
                $("sidebar-biz-name").innerHTML =
                    `<i data-lucide="sparkles"></i> ${config.name}`;
            if ($("p-biz-name"))
                $("p-biz-name").innerText = config.name.toUpperCase();
            if ($("p-biz-address")) $("p-biz-address").innerText = config.address;
            if ($("p-biz-phone")) $("p-biz-phone").innerText = config.phone;
            if ($("p-footer-biz")) $("p-footer-biz").innerText = config.name;

            // Bank details display
            if (config.bankName && config.accountNumber) {
                if ($("p-bank-details")) $("p-bank-details").style.display = "block";
                if ($("p-bank-name")) $("p-bank-name").innerText = config.bankName;
                if ($("p-account-number")) $("p-account-number").innerText = config.accountNumber;
                if ($("p-account-name")) $("p-account-name").innerText = config.accountName || "";
            } else {
                if ($("p-bank-details")) $("p-bank-details").style.display = "none";
            }

            document.title = `${config.name} â€“ Pro POS`;
            if (window.lucide) lucide.createIcons();
        }

        function showSetup() {
            const active = localStorage.getItem(activeStaffKey) || "Admin";
            if (active !== "Admin") {
                isAuthorizingForSettings = true;
                selectForLogin("Admin");
                if ($("loginOverlay")) $("loginOverlay").style.display = "flex";
                if ($("loginTitle"))
                    $("loginTitle").innerText = "Manager Authorization";
                return;
            }
            openSetupModal();
        }

        function openSetupModal() {
            const config = JSON.parse(localStorage.getItem(bizKey) || "{}");
            if ($("setup-name")) $("setup-name").value = config.name || "";
            if ($("setup-address")) $("setup-address").value = config.address || "";
            if ($("setup-phone")) $("setup-phone").value = config.phone || "";
            if ($("setup-admin-pin"))
                $("setup-admin-pin").value = config.adminPin || "0000";
            if ($("setup-bank-name")) $("setup-bank-name").value = config.bankName || "";
            if ($("setup-account-number")) $("setup-account-number").value = config.accountNumber || "";
            if ($("setup-account-name")) $("setup-account-name").value = config.accountName || "";
            if ($("setupOverlay")) $("setupOverlay").style.display = "flex";
        }

        let revenueChartModalInstance = null;


        function hideSetup() {
            if ($("setupOverlay")) $("setupOverlay").style.display = "none";
        }

        function saveBusinessConfig() {
            const config = {
                name: $("setup-name").value,
                address: $("setup-address").value,
                phone: $("setup-phone").value,
                adminPin: $("setup-admin-pin").value || "0000",
                bankName: $("setup-bank-name").value,
                accountNumber: $("setup-account-number").value,
                accountName: $("setup-account-name").value,
            };
            if (!config.name || !config.address) return alert("Fill all fields.");
            localStorage.setItem(bizKey, JSON.stringify(config));
            loadBusinessConfig();
            hideSetup();
            showToast("Business Profile Updated!");
        }

        function addStaffMember() {
            const n = $("newStaffName").value.trim(),
                p = $("newStaffPin").value.trim();
            if (!n || p.length !== 4) return alert("Invalid PIN.");
            let s = JSON.parse(localStorage.getItem(staffKey) || "[]");
            if (s.find((x) => x.name === n)) return alert("Exists.");
            s.push({ name: n, pin: p });
            localStorage.setItem(staffKey, JSON.stringify(s));
            $("newStaffName").value = "";
            $("newStaffPin").value = "";
            renderStaffManagement();
        }

        function removeStaffMember(n) {
            let s = JSON.parse(localStorage.getItem(staffKey) || "[]");
            s = s.filter((x) => x.name !== n);
            localStorage.setItem(staffKey, JSON.stringify(s));
            if (localStorage.getItem(activeStaffKey) === n)
                localStorage.setItem(activeStaffKey, "Admin");
            renderStaffManagement();
            updateStaffSwitcher();
        }

        function renderStaffManagement() {
            const c = $("staffManageList");
            if (!c) return;
            const s = JSON.parse(localStorage.getItem(staffKey) || "[]");
            c.innerHTML = s
                .map(
                    (x) =>
                        `<div class="staff-list-item"><span>${x.name}</span><button class="btn-icon" onclick="removeStaffMember('${x.name}')"><i data-lucide="trash-2"></i></button></div>`,
                )
                .join("");
            if (window.lucide) lucide.createIcons();
        }

        function updateStaffSwitcher() {
            const a = localStorage.getItem(activeStaffKey) || "Admin";
            if ($("currentStaffName")) $("currentStaffName").innerText = a;
            if ($("p-staff")) $("p-staff").innerText = a;
        }

        function triggerSwitch() {
            isAuthorizingForSettings = false;
            if ($("loginOverlay")) $("loginOverlay").style.display = "flex";
            if ($("accountSelector")) $("accountSelector").style.display = "grid";
            if ($("pinEntry")) $("pinEntry").style.display = "none";
            const s = JSON.parse(localStorage.getItem(staffKey) || "[]");
            let h = `<button class="secondary" onclick="selectForLogin('Admin')" style="height:80px">Admin</button>`;
            h += s
                .map(
                    (x) =>
                        `<button class="secondary" onclick="selectForLogin('${x.name}')" style="height:80px">${x.name}</button>`,
                )
                .join("");
            if ($("accountSelector")) $("accountSelector").innerHTML = h;
        }

        function selectForLogin(n) {
            targetStaff = n;
            currentPinDraft = "";
            $("accountSelector").style.display = "none";
            $("pinEntry").style.display = "block";
            $("loginSubtitle").innerText = "Enter PIN for " + n;
            updatePinDisplay();
        }

        function backToAccounts() {
            $("pinEntry").style.display = "none";
            $("accountSelector").style.display = "grid";
        }
        function pressPin(v) {
            if (currentPinDraft.length < 4) {
                currentPinDraft += v;
                updatePinDisplay();
                if (currentPinDraft.length === 4) setTimeout(verifyLogin, 100);
            }
        }
        function clearPin() {
            currentPinDraft = currentPinDraft.slice(0, -1);
            updatePinDisplay();
        }
        function updatePinDisplay() {
            if ($("pinDisplay"))
                $("pinDisplay").innerText =
                    "*".repeat(currentPinDraft.length) || "----";
        }

        function verifyLogin() {
            let p = "";
            if (targetStaff === "Admin") {
                p =
                    JSON.parse(localStorage.getItem(bizKey) || "{}").adminPin || "0000";
            } else {
                p = (
                    JSON.parse(localStorage.getItem(staffKey) || "[]").find(
                        (x) => x.name === targetStaff,
                    ) || {}
                ).pin;
            }
            if (currentPinDraft === p) {
                if (isAuthorizingForSettings) {
                    isAuthorizingForSettings = false;
                    $("loginOverlay").style.display = "none";
                    openSetupModal();
                    return;
                }
                localStorage.setItem(activeStaffKey, targetStaff);
                updateStaffSwitcher();
                $("loginOverlay").style.display = "none";
                showToast("Welcome " + targetStaff);
                calculate();
            } else {
                currentPinDraft = "";
                updatePinDisplay();
                showToast("Wrong PIN", true);
            }
        }

        function resetForm() {
            if ($("customer")) $("customer").value = "";
            if ($("phone")) $("phone").value = "";
            if ($("sidebarItems")) $("sidebarItems").innerHTML = "";
            if ($("orderStatus")) $("orderStatus").value = "Received";
            editingOrderId = null; // Clear edit mode
            carriedBalance = 0;
            currentPromptedCustomer = "";
            if ($("p-old-balance-row")) $("p-old-balance-row").style.display = "none";
            addItem();
            calculate();
        }

        function quickAdd(n, p) {
            addItem({ name: n, price: p, qty: 1 });
        }

        function addItem(d = {}) {
            const l = $("sidebarItems");
            if (!l) return;
            const r = document.createElement("div");
            r.className = "item-row";
            r.innerHTML = `
                    <input type="text" placeholder="Item Name" value="${d.name || ""}" oninput="calculate()">
                    <input type="number" placeholder="Qty" value="${d.qty || 1}" oninput="calculate()" class="text-center">
                    <input type="number" placeholder="Price" value="${d.price || 0}" oninput="calculate()" class="text-right">
                    <button class="btn-icon" onclick="this.parentElement.remove();calculate()"><i data-lucide="trash-2" style="width:14px"></i></button>
                `;
            l.appendChild(r);
            if (window.lucide) lucide.createIcons();
            calculate();
        }

        function calculate() {
            let s = 0;
            const b = $("p-itemsBody");
            if (!b) return;
            b.innerHTML = "";
            if ($("p-customer"))
                $("p-customer").innerText = $("customer").value || "---";
            if ($("p-phone")) $("p-phone").innerText = $("phone").value || "---";
            if ($("p-date")) $("p-date").innerText = $("date").value || "---";
            document.querySelectorAll("#sidebarItems .item-row").forEach((r, i) => {
                const ins = r.querySelectorAll("input");
                const n = ins[0].value,
                    q = +ins[1].value || 0,
                    p = +ins[2].value || 0,
                    sub = q * p;
                s += sub;
                if (n || q > 0) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${n || "Item"}</td>
                        <td class="text-center">${q}</td>
                        <td class="text-right">${p.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        <td class="text-right">${sub.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    `;
                    b.appendChild(tr);
                }
            });
            const f =
                "â‚¦" + s.toLocaleString(undefined, { minimumFractionDigits: 2 });
            if ($("p-subtotal")) $("p-subtotal").innerText = f;

            const totalWithCarried = s + carriedBalance;
            const ft = "â‚¦" + totalWithCarried.toLocaleString(undefined, { minimumFractionDigits: 2 });
            if ($("p-total")) $("p-total").innerText = ft;

            if ($("p-old-balance-row")) {
                if (carriedBalance > 0) {
                    $("p-old-balance-row").style.display = "flex";
                    $("p-old-balance-row").style.justifyContent = "space-between";
                    $("p-old-balance").innerText = "â‚¦" + carriedBalance.toLocaleString(undefined, { minimumFractionDigits: 2 });
                } else {
                    $("p-old-balance-row").style.display = "none";
                }
            }

            const pStatus = $("paymentStatus") ? $("paymentStatus").value : "Not Paid";
            const amtPaid = parseFloat($("amountPaid") ? $("amountPaid").value : 0) || 0;
            const balance = totalWithCarried - amtPaid;
            const fb = "â‚¦" + (balance > 0 ? balance : 0).toLocaleString(undefined, { minimumFractionDigits: 2 });
            const fp = "â‚¦" + amtPaid.toLocaleString(undefined, { minimumFractionDigits: 2 });

            if ($("p-paid")) $("p-paid").innerText = fp;
            if ($("p-due")) $("p-due").innerText = fb;
            if ($("p-pay-status")) $("p-pay-status").innerText = pStatus;
        }

        function togglePaidInput() {
            const status = $("paymentStatus").value;
            const group = $("paidInputGroup");
            if (status === "Partly Paid" || status === "Paid") {
                group.style.display = "block";
            } else {
                group.style.display = "none";
                $("amountPaid").value = 0;
            }
        }

        function saveReceipt(e) {
            const n = $("customer").value;
            if (!n) return alert("Enter name.");
            const items = [];
            document.querySelectorAll("#sidebarItems .item-row").forEach((r) => {
                const ins = r.querySelectorAll("input");
                if (ins[0].value)
                    items.push({
                        name: ins[0].value,
                        qty: ins[1].value,
                        price: ins[2].value,
                    });
            });

            const active = localStorage.getItem(activeStaffKey) || "Admin";
            const record = {
                id: editingOrderId || Date.now(),
                customer: n,
                phone: $("phone").value,
                date: $("date").value,
                total: $("p-total").innerText,
                items: items,
                staff: active,
                status: $("orderStatus").value,
                paymentStatus: $("paymentStatus").value,
                amountPaid: $("amountPaid").value || 0,
                carriedBalance: carriedBalance
            };

            const h = JSON.parse(localStorage.getItem(historyKey) || "[]");
            if (editingOrderId) {
                const idx = h.findIndex((x) => x.id === editingOrderId);
                if (idx !== -1) h[idx] = record;
                else h.push(record);
            } else {
                h.push(record);
            }

            localStorage.setItem(historyKey, JSON.stringify(h));

            const loyalty = JSON.parse(localStorage.getItem(loyaltyKey) || "{}");
            if (!editingOrderId) {
                // Only increment loyalty for brand new orders
                loyalty[n] = (loyalty[n] || 0) + 1;
                localStorage.setItem(loyaltyKey, JSON.stringify(loyalty));
            }

            renderHistory();
            updateSummary();
            updateChart();
            const btn = e ? e.currentTarget : null;
            if (btn) {
                const old = btn.innerHTML;
                btn.innerHTML = "Saved!";
                btn.style.background = "#10b981";
                setTimeout(() => {
                    btn.innerHTML = old;
                    btn.style.background = "";
                }, 2000);
            }
            if (!editingOrderId) resetForm(); // Only reset if it's a new order
        }

        function updateSummary() {
            const h = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const now = new Date();
            const todayStr = now.toLocaleString("en-NG", { dateStyle: "medium" });

            let dailyTotal = 0,
                pendingCollection = 0,
                unpaidDebt = 0;

            h.forEach((r) => {
                const totalVal = parseFloat(r.total.replace(/[â‚¦,]/g, "")) || 0;
                const paidVal = parseFloat(r.amountPaid || 0) || 0;
                const balance = totalVal - paidVal;

                if (r.date.includes(todayStr)) dailyTotal += totalVal;

                if (r.status === "Ready") pendingCollection++;
                if (balance > 0) unpaidDebt += balance;
            });

            const fmt = (v) =>
                "â‚¦" + v.toLocaleString(undefined, { minimumFractionDigits: 0 });

            if ($("dailyTotal"))
                $("dailyTotal").innerText = fmt(dailyTotal);
            if ($("statDaily")) $("statDaily").innerText = fmt(dailyTotal);
            if ($("statPendingCount")) $("statPendingCount").innerText = pendingCollection;
            if ($("statUnpaidDebt")) $("statUnpaidDebt").innerText = fmt(unpaidDebt);
        }

        function renderHistory() {
            const list = $("historyList");
            if (!list) return;
            const searchTerm = ($("historySearch")?.value || "").toLowerCase();
            const statusFilter = $("historyStatusFilter")?.value || "All";

            list.innerHTML = "";
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");

            const filtered = history
                .filter((x) => {
                    const nameMatch = x.customer.toLowerCase().includes(searchTerm);
                    const statusMatch =
                        statusFilter === "All" ||
                        (x.status || "Received") === statusFilter;
                    return nameMatch && statusMatch;
                })
                .reverse();

            const toShow = showAllHistoryItems ? filtered : filtered.slice(0, 5);

            toShow.forEach((x) => {
                const d = document.createElement("div");
                d.className = "history-card";
                const status = x.status || "Received";
                const pStatus = x.paymentStatus || "Not Paid";

                const statusClass = "status-" + status.toLowerCase();
                const pStatusClass = "pay-" + pStatus.replace(" ", "").toLowerCase();

                d.innerHTML = `
                        <div class="meta">
                            <strong>${x.customer}</strong> â€¢ ${x.date}<br>
                            <small>Op: ${x.staff || "Admin"}</small>
                        </div>
                        <div style="text-align:right">
                            <div class="total">${x.total}</div>
                            <div style="display: flex; gap: 4px; justify-content: flex-end; margin-top: 4px;">
                                <select class="badge ${statusClass}" 
                                    onchange="updateStatusFast(${x.id}, this.value, event)" 
                                    onclick="event.stopPropagation()" style="font-size: 9px; padding-top: 1px; padding-bottom: 1px;">
                                    <option value="Received" ${status === 'Received' ? 'selected' : ''}>Received</option>
                                    <option value="Processing" ${status === 'Processing' ? 'selected' : ''}>Processing</option>
                                    <option value="Ready" ${status === 'Ready' ? 'selected' : ''}>Ready</option>
                                    <option value="Collected" ${status === 'Collected' ? 'selected' : ''}>Collected</option>
                                </select>
                                <select class="badge ${pStatusClass}" 
                                    onchange="updatePaymentStatusFast(${x.id}, this.value, event)" 
                                    onclick="event.stopPropagation()" style="font-size: 9px; padding-top: 1px; padding-bottom: 1px;">
                                    <option value="Not Paid" ${pStatus === 'Not Paid' ? 'selected' : ''}>Unpaid</option>
                                    <option value="Partly Paid" ${pStatus === 'Partly Paid' ? 'selected' : ''}>Partial</option>
                                    <option value="Paid" ${pStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                                </select>
                            </div>
                        </div>
                    `;
                d.onclick = () => loadHistory(x);
                list.appendChild(d);
            });

            if (filtered.length === 0) {
                list.innerHTML =
                    '<div style="font-size:10px; color:#94a3b8; text-align:center; padding:10px;">No records found.</div>';
            }
            if (window.lucide) lucide.createIcons();
        }

        function toggleAllHistory() {
            showAllHistoryItems = !showAllHistoryItems;
            if ($("historyToggleBtn"))
                $("historyToggleBtn").innerText = showAllHistoryItems
                    ? "HIDE"
                    : "SHOW ALL";
            renderHistory();
        }

        function loadHistory(x) {
            editingOrderId = x.id || null;
            $("customer").value = x.customer;
            $("phone").value = x.phone;
            $("date").value = x.date;
            if ($("orderStatus")) $("orderStatus").value = x.status || "Received";
            if ($("paymentStatus")) $("paymentStatus").value = x.paymentStatus || "Not Paid";
            if ($("amountPaid")) $("amountPaid").value = x.amountPaid || 0;
            carriedBalance = x.carriedBalance || 0;
            currentPromptedCustomer = x.customer; // Don't prompt again for this one
            togglePaidInput();
            $("sidebarItems").innerHTML = "";
            x.items.forEach(addItem);
            calculate();
        }

        function updateChart() {
            if (!window.Chart) return;
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const days = [];
            const dataArr = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const label = d.toLocaleDateString("en-NG", {
                    day: "numeric",
                    month: "short",
                });
                const full = d.toLocaleDateString("en-NG", { dateStyle: "medium" });
                days.push(label);
                let daySum = 0;
                history.forEach((r) => {
                    if (r.date && r.date.includes(full))
                        daySum += parseFloat(r.total.replace(/[â‚¦,]/g, "")) || 0;
                });
                dataArr.push(daySum);
            }

            const chartData = {
                labels: days,
                datasets: [
                    {
                        label: "Revenue",
                        data: dataArr,
                        borderColor: "#4f46e5",
                        backgroundColor: "rgba(79, 70, 229, 0.1)",
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                    },
                ],
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } },
            };

            // Main View Chart
            if ($("revenueChart")) {
                const ctx = $("revenueChart").getContext("2d");
                if (revenueChartInstance) revenueChartInstance.destroy();
                revenueChartInstance = new Chart(ctx, {
                    type: "line",
                    data: chartData,
                    options: chartOptions,
                });
            }

            // Modal Chart
            if ($("revenueChartModal")) {
                const ctxM = $("revenueChartModal").getContext("2d");
                if (revenueChartModalInstance) revenueChartModalInstance.destroy();
                revenueChartModalInstance = new Chart(ctxM, {
                    type: "line",
                    data: chartData,
                    options: chartOptions,
                });
            }
        }

        function updateLoyalty() {
            const n = $("customer").value.trim();
            const badge = $("loyalty-badge");
            if (!n) {
                badge.style.display = "none";
                carriedBalance = 0;
                currentPromptedCustomer = "";
                if ($("p-old-balance-row")) $("p-old-balance-row").style.display = "none";
                calculate();
                return;
            }

            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const customerRecord = history.find(h => h.customer.toLowerCase() === n.toLowerCase());

            // Auto-fill phone if match found and phone field is empty
            if (customerRecord && customerRecord.phone && !$("phone").value) {
                $("phone").value = customerRecord.phone;
            }

            // Check for balance if this is a brand new customer entry (not in edit mode)
            if (!editingOrderId && n.toLowerCase() !== currentPromptedCustomer.toLowerCase()) {
                const customersInHistory = history.filter(h => h.customer.toLowerCase() === n.toLowerCase());
                if (customersInHistory.length > 0) {
                    let totalDebt = 0;
                    customersInHistory.forEach(r => {
                        const t = parseFloat(r.total.replace(/[â‚¦,]/g, '')) || 0;
                        const p = parseFloat(r.amountPaid || 0) || 0;
                        totalDebt += (t - p);
                    });

                    if (totalDebt > 1) { // Only prompt if debt is more than 1 Naira
                        showBalancePrompt(n, totalDebt);
                    }
                }
            }

            const loyalty = JSON.parse(localStorage.getItem(loyaltyKey) || "{}");
            const count = loyalty[n] || 0;

            if (count > 0) {
                badge.innerText = `${count} visit${count > 1 ? "s" : ""}`;
                badge.style.display = "inline-block";
            } else {
                badge.style.display = "none";
            }
            calculate();
        }

        function showBalancePrompt(name, debt) {
            currentPromptedCustomer = name;
            $("balancePromptText").innerHTML = `<b>${name}</b> has an outstanding balance of <b>â‚¦${debt.toLocaleString()}</b>.`;
            $("balanceOverlay").setAttribute('data-debt', debt);
            $("balanceOverlay").style.display = "flex";
        }

        function resolveBalancePrompt(add) {
            const debt = parseFloat($("balanceOverlay").getAttribute('data-debt')) || 0;
            if (add) {
                carriedBalance = debt;
                showToast("Balance added to invoice");
            } else {
                carriedBalance = 0;
                showToast("Balance skipped");
            }
            $("balanceOverlay").style.display = "none";
            calculate();
        }
        function updateCustomerSuggestions() {
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const customers = [...new Set(history.map(h => h.customer))];
            const datalist = $("customers");
            if (datalist) {
                datalist.innerHTML = customers.map(c => `<option value="${c}">${c}</option>`).join("");
            }
        }
        async function shareWhatsApp() {
            const config = JSON.parse(localStorage.getItem(bizKey)) || {
                name: "Business",
            };
            const customerName = $("customer").value || "Customer";
            const phone = $("phone").value || "";
            const total = $("p-total").innerText;
            const msg = `Hello ${customerName}, here is your receipt from ${config.name}. Total: ${total}`;

            if (!window.html2canvas) return alert("Sharing library not loaded.");

            try {
                showToast("Generating receipt image...");

                // Capture the receipt with higher quality
                const canvas = await html2canvas($("receipt"), {
                    scale: 2, // Double resolution for clarity
                    backgroundColor: "#ffffff",
                    useCORS: true,
                    logging: false,
                });

                const blob = await new Promise((resolve) =>
                    canvas.toBlob(resolve, "image/png"),
                );
                const file = new File(
                    [blob],
                    `receipt-${customerName.replace(/\s+/g, "_")}.png`,
                    { type: "image/png" },
                );

                // Check if the browser supports sharing files
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: `Receipt from ${config.name}`,
                        text: msg,
                        files: [file],
                    });
                } else {
                    // Fallback for Desktop/Unsupported browsers
                    let formattedPhone = phone.replace(/\D/g, ""); // Remove non-numeric characters

                    // Simple logic for Nigerian numbers: if it starts with 0 and is 11 digits, replace with 234
                    if (
                        formattedPhone.startsWith("0") &&
                        formattedPhone.length === 11
                    ) {
                        formattedPhone = "234" + formattedPhone.substring(1);
                    }

                    const waBase = formattedPhone
                        ? `https://api.whatsapp.com/send?phone=${formattedPhone}`
                        : `https://api.whatsapp.com/send?text=`;
                    const waUrl = formattedPhone
                        ? `${waBase}&text=${encodeURIComponent(msg)}`
                        : `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;

                    window.open(waUrl, "_blank");

                    // Trigger image download
                    const a = document.createElement("a");
                    a.href = canvas.toDataURL("image/png");
                    a.download = `receipt-${customerName}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    showToast("Opening WhatsApp... Image downloaded.", false);
                }
            } catch (err) {
                console.error("Shared failed:", err);
                showToast("Share failed. Please use Print/Save.", true);
            }
        }

        function exportHistory() {
            const h = JSON.parse(localStorage.getItem(historyKey) || "[]");
            if (!h.length) return alert("Nothing to export.");
            let csv = "Date,Customer,Total,Staff,Items\n";
            h.forEach((x) => {
                const items = x.items
                    ? x.items.map((i) => `${i.qty}x ${i.name}`).join(" | ")
                    : "";
                csv += `"${x.date}","${x.customer}","${x.total}","${x.staff || "Admin"}","${items}"\n`;
            });
            const blob = new Blob([csv], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `sales_export.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        function clearAllData() {
            if (confirm("Clear?")) {
                localStorage.removeItem(historyKey);
                renderHistory();
                updateSummary();
            }
        }
        function showToast(m, err = false) {
            const t = document.createElement("div");
            t.style =
                "position:fixed; top:20px; left:50%; transform:translateX(-50%); background:" +
                (err ? "#ef4444" : "#10b981") +
                "; color:white; padding:12px; border-radius:8px; z-index:9999;";
            t.innerText = m;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        // --- Analytics Logic ---
        function openAnalytics() {
            $("analyticsOverlay").style.display = "flex";
            switchAnalyticsTab('day');
        }

        function closeAnalytics() {
            $("analyticsOverlay").style.display = "none";
        }

        function switchAnalyticsTab(period) {
            document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
            $("tab-" + period).classList.add('active');
            renderAnalytics(period);
        }

        function renderAnalytics(period) {
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const now = new Date();
            let filtered = [];

            if (period === 'day') {
                const today = now.toLocaleString("en-NG", { dateStyle: "medium" });
                filtered = history.filter(h => h.date.includes(today));
            } else if (period === 'week') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(now.getDate() - 7);
                filtered = history.filter(h => new Date(h.id) >= oneWeekAgo);
            } else if (period === 'month') {
                const monthStr = now.toLocaleString("en-NG", { month: "short", year: "numeric" });
                filtered = history.filter(h => h.date.includes(monthStr));
            } else if (period === 'year') {
                const yearStr = now.getFullYear().toString();
                filtered = history.filter(h => h.date.includes(yearStr));
            }

            // Calculations
            let totalRevenue = 0;
            let totalOrders = filtered.length;
            let totalDebt = 0;
            let pendingItems = 0;

            const customerCounts = {};
            const serviceCounts = {};
            let uniqueCustomers = new Set();

            filtered.forEach(h => {
                const total = (parseFloat(h.total.replace(/[â‚¦,]/g, "")) || 0);
                const paid = (parseFloat(h.amountPaid || 0) || 0);

                totalRevenue += total;
                totalDebt += (total - paid);
                if (h.status === "Ready") pendingItems++;

                uniqueCustomers.add(h.customer);
                customerCounts[h.customer] = (customerCounts[h.customer] || 0) + total;

                h.items.forEach(item => {
                    serviceCounts[item.name] = (serviceCounts[item.name] || 0) + parseInt(item.qty);
                });
            });

            const topCustomer = Object.entries(customerCounts).sort((a, b) => b[1] - a[1])[0] || ["None", 0];
            const topServices = Object.entries(serviceCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const content = $("analyticsContent");
            content.innerHTML = `
                <div class="analytics-grid-card">
                    <div class="lbl">Total Revenue</div>
                    <div class="val">â‚¦${totalRevenue.toLocaleString()}</div>
                </div>
                <div class="analytics-grid-card">
                    <div class="lbl">Unpaid Balance</div>
                    <div class="val" style="color: #ef4444;">â‚¦${totalDebt.toLocaleString()}</div>
                </div>
                <div class="analytics-grid-card">
                    <div class="lbl">Orders Ready</div>
                    <div class="val">${pendingItems}</div>
                </div>
                <div class="analytics-grid-card">
                    <div class="lbl">Total Orders</div>
                    <div class="val">${totalOrders}</div>
                </div>
                <div class="analytics-grid-card">
                    <div class="lbl">Unique Customers</div>
                    <div class="val">${uniqueCustomers.size}</div>
                </div>
                <div class="analytics-grid-card">
                    <div class="lbl">Top Customer</div>
                    <div class="val" style="font-size: 14px;">${topCustomer[0]}</div>
                    <div class="lbl">Spent: â‚¦${topCustomer[1].toLocaleString()}</div>
                </div>
                <div class="analytics-grid-card" style="grid-column: span 2;">
                    <div class="lbl">Most Requested Services</div>
                    <div style="margin-top: 8px;">
                        ${topServices.map(([name, count]) => `
                            <div class="analytics-list-item">
                                <span>${name}</span>
                                <strong>${count} units</strong>
                            </div>
                        `).join("") || '<div class="lbl">No data available</div>'}
                    </div>
                </div>
            `;

            if (window.lucide) lucide.createIcons();

            // Redraw chart in modal to ensure it fits the new layout
            setTimeout(updateChart, 100);
        }

        // --- Customer Directory Logic ---
        function openCustomerDirectory() {
            $("customerOverlay").style.display = "flex";
            $("customerDetailView").style.display = "none";
            $("customerList").style.display = "flex";
            renderCustomerList();
        }

        function closeCustomerDirectory() {
            $("customerOverlay").style.display = "none";
        }

        function backToCustomerList() {
            $("customerDetailView").style.display = "none";
            $("customerList").style.display = "flex";
        }

        function renderCustomerList() {
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const searchTerm = ($("customerSearch")?.value || "").toLowerCase();
            const customersMap = {};

            history.forEach(h => {
                const name = h.customer;
                if (!customersMap[name]) {
                    customersMap[name] = {
                        name: name,
                        phone: h.phone || "No phone",
                        visits: 0,
                        totalSpent: 0
                    };
                }
                customersMap[name].visits++;
                customersMap[name].totalSpent += (parseFloat(h.total.replace(/[â‚¦,]/g, "")) || 0);
            });

            const customers = Object.values(customersMap).filter(c =>
                c.name.toLowerCase().includes(searchTerm) ||
                c.phone.includes(searchTerm)
            ).sort((a, b) => b.totalSpent - a.totalSpent);

            const list = $("customerList");
            list.innerHTML = customers.map(c => `
                <div class="history-card" onclick="viewCustomerDetails('${c.name.replace(/'/g, "\\'")}')">
                    <div class="meta">
                        <strong>${c.name}</strong><br>
                        <small>${c.phone}</small>
                    </div>
                    <div style="text-align: right;">
                        <div class="total">â‚¦${c.totalSpent.toLocaleString()}</div>
                        <span class="badge">${c.visits} visit${c.visits > 1 ? 's' : ''}</span>
                    </div>
                </div>
            `).join("") || '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No customers found.</div>';

            if (window.lucide) lucide.createIcons();
        }

        function viewCustomerDetails(name) {
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const customerHistory = history.filter(h => h.customer === name).reverse();
            const totalSpent = customerHistory.reduce((acc, h) => acc + (parseFloat(h.total.replace(/[â‚¦,]/g, "")) || 0), 0);
            const phone = customerHistory[0].phone || "No phone recorded";

            $("customerList").style.display = "none";
            $("customerDetailView").style.display = "block";

            const detailContent = $("customerDetailContent");
            detailContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px;">${name}</h3>
                    <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 12px;">${phone}</div>
                    <div style="display: flex; gap: 12px;">
                        <div class="analytics-grid-card" style="flex: 1; padding: 10px;">
                            <div class="lbl">Lifetime Value</div>
                            <div class="val" style="font-size: 16px;">â‚¦${totalSpent.toLocaleString()}</div>
                        </div>
                        <div class="analytics-grid-card" style="flex: 1; padding: 10px;">
                            <div class="lbl">Visits</div>
                            <div class="val" style="font-size: 16px;">${customerHistory.length}</div>
                        </div>
                    </div>
                </div>
                <div class="section-title">Visit History</div>
                <div style="display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto;">
                    ${customerHistory.map(h => `
                        <div class="history-card" style="cursor: default;">
                            <div class="meta">
                                <strong>${h.date}</strong><br>
                                <small>${h.items.map(i => i.name).join(", ")}</small>
                            </div>
                            <div style="text-align: right;">
                                <div class="total">${h.total}</div>
                                <span class="badge ${'status-' + (h.status || 'Received').toLowerCase()}">${h.status || 'Received'}</span>
                            </div>
                        </div>
                    `).join("")}
                </div>
            `;
            if (window.lucide) lucide.createIcons();
        }

        // --- Status Logic ---
        function updateStatusFast(id, newStatus, event) {
            if (event) event.stopPropagation();
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const idx = history.findIndex(x => x.id == id);
            if (idx !== -1) {
                history[idx].status = newStatus;
                localStorage.setItem(historyKey, JSON.stringify(history));

                // Also update loyalty if needed (though usually not status dependent)

                showToast(`Status updated to ${newStatus}`);
                renderHistory();
                updateSummary();
            }
        }

        function updatePaymentStatusFast(id, newStatus, event) {
            if (event) event.stopPropagation();
            const history = JSON.parse(localStorage.getItem(historyKey) || "[]");
            const idx = history.findIndex(x => x.id == id);
            if (idx !== -1) {
                history[idx].paymentStatus = newStatus;

                // If switching to 'Paid', auto-fill amountPaid to match total for accurate accounting
                if (newStatus === "Paid") {
                    const totalVal = parseFloat(history[idx].total.replace(/[â‚¦,]/g, "")) || 0;
                    history[idx].amountPaid = totalVal;
                }

                localStorage.setItem(historyKey, JSON.stringify(history));
                showToast(`Payment: ${newStatus}`);
                renderHistory();
                updateSummary();
            }
        }

        window.onload = init;
    </script>
</body>

</html>